name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'

jobs:
  # =====================================================
  # Code Quality & Testing
  # =====================================================
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies - Producer
        run: |
          cd services/producer
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black

      - name: Install dependencies - Processor
        run: |
          cd services/processor
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black

      - name: Run Black (Format Check)
        run: |
          black --check services/producer services/processor

      - name: Run Flake8 (Linting)
        run: |
          flake8 services/producer services/processor --max-line-length=100 --ignore=E501,W503

      - name: Run Tests - Producer
        run: |
          cd services/producer
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

      - name: Run Tests - Processor
        run: |
          cd services/processor
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

      - name: Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          files: ./services/producer/coverage.xml,./services/processor/coverage.xml
          flags: unittests
          name: codecov-umbrella

  # =====================================================
  # Terraform Validation
  # =====================================================
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd infrastructure/terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd infrastructure/terraform/environments/dev
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd infrastructure/terraform/environments/dev
          terraform validate

  # =====================================================
  # Security Scanning
  # =====================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Checkov (Terraform Security)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/terraform
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif

  # =====================================================
  # Build Lambda Packages
  # =====================================================
  build:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    needs: [test, terraform-validate]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Producer Lambda
        run: |
          cd services/producer
          mkdir -p layer/python
          pip install -r requirements.txt -t ./layer/python --platform manylinux2014_x86_64 --only-binary=:all: --no-deps
          cd layer
          zip -r ../layer.zip python -x "*.pyc" "*.pyo" "*__pycache__*" "*.dist-info*"
          cd ..
          zip lambda.zip app.py
          rm -rf layer

      - name: Build Processor Lambda
        run: |
          cd services/processor
          mkdir -p layer/python
          pip install -r requirements.txt -t ./layer/python --platform manylinux2014_x86_64 --only-binary=:all: --no-deps
          cd layer
          zip -r ../layer.zip python -x "*.pyc" "*.pyo" "*__pycache__*" "*.dist-info*"
          cd ..
          zip lambda.zip app.py
          rm -rf layer

      - name: Upload Producer Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: producer-lambda
          path: |
            services/producer/lambda.zip
            services/producer/layer.zip
          retention-days: 7

      - name: Upload Processor Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: processor-lambda
          path: |
            services/processor/lambda.zip
            services/processor/layer.zip
          retention-days: 7

  # =====================================================
  # Deploy to Dev Environment
  # =====================================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: dev
      url: https://console.aws.amazon.com/lambda
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Producer Artifacts
        uses: actions/download-artifact@v3
        with:
          name: producer-lambda
          path: services/producer

      - name: Download Processor Artifacts
        uses: actions/download-artifact@v3
        with:
          name: processor-lambda
          path: services/processor

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd infrastructure/terraform/environments/dev
          terraform init

      - name: Terraform Plan
        run: |
          cd infrastructure/terraform/environments/dev
          terraform plan -out=tfplan \
            -var="stock_api_key=${{ secrets.STOCK_API_KEY }}" \
            -var="dynamodb_table_name=stock-realtime-dev" \
            -var="s3_bucket_name=stock-historical-data-dev-${{ github.run_number }}"

      - name: Terraform Apply
        run: |
          cd infrastructure/terraform/environments/dev
          terraform apply -auto-approve tfplan

      - name: Get Lambda Function Names
        id: lambda-output
        run: |
          cd infrastructure/terraform/environments/dev
          echo "producer=$(terraform output -raw producer_lambda_function_name)" >> $GITHUB_OUTPUT
          echo "processor=$(terraform output -raw processor_lambda_function_name)" >> $GITHUB_OUTPUT

      - name: Update Lambda Functions
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.lambda-output.outputs.producer }} \
            --s3-bucket stock-historical-data-dev-${{ github.run_number }} \
            --s3-key lambda/stock-data-producer.zip
          
          aws lambda update-function-code \
            --function-name ${{ steps.lambda-output.outputs.processor }} \
            --s3-bucket stock-historical-data-dev-${{ github.run_number }} \
            --s3-key lambda/stock-stream-processor.zip

  # =====================================================
  # Deploy to Production
  # =====================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://console.aws.amazon.com/lambda
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Producer Artifacts
        uses: actions/download-artifact@v3
        with:
          name: producer-lambda
          path: services/producer

      - name: Download Processor Artifacts
        uses: actions/download-artifact@v3
        with:
          name: processor-lambda
          path: services/processor

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd infrastructure/terraform/environments/prod
          terraform init

      - name: Terraform Plan
        run: |
          cd infrastructure/terraform/environments/prod
          terraform plan -out=tfplan \
            -var="stock_api_key=${{ secrets.STOCK_API_KEY_PROD }}" \
            -var="dynamodb_table_name=stock-realtime-prod" \
            -var="s3_bucket_name=stock-historical-data-prod-${{ github.run_number }}"

      - name: Terraform Apply
        run: |
          cd infrastructure/terraform/environments/prod
          terraform apply -auto-approve tfplan

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            Production deployment completed successfully.
            - Producer Lambda: Updated
            - Processor Lambda: Updated
            - Infrastructure: Updated via Terraform
          draft: false
          prerelease: false